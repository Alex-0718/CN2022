(function(){"use strict";var t={9205:function(t,e,n){var s=n(144),r=n(1096),o=function(){var t=this,e=t._self._c;return e(r.Z,{staticClass:"tw-h-screen tw-flex tw-flex-col",attrs:{id:"app"}},[e("Header",{staticClass:"tw-shadow-[0_0_3px_0_#0004]"}),e("router-view",{staticClass:"tw-flex-1 tw-overflow-y-scroll"}),e("Navigation",{staticClass:"tw-shadow-[0_0_3px_0_#0004]"})],1)},i=[],a=(n(7658),function(){var t=this,e=t._self._c;return e("div",{staticClass:"tw-flex tw-flex-row tw-h-16 tw-items-center tw-px-4 tw-bg-primary tw-text-white"},[e("h1",{staticClass:"tw-flex-1 tw-text-left tw-text-2xl"},[t._v("Messaging")]),t.$store.state.loggedIn?e("div",[e("span",{staticClass:"px-1"},[t._v("Hi, "+t._s(t.$store.state.username))]),e("span",{staticClass:"px-1",on:{click:t.logout}},[t._v("登出")])]):e("div",[e("router-link",{staticClass:"tw-text-white",attrs:{to:"/"}},[e("span",[t._v("請先登入")])])],1)])}),c=[],l={name:"Header",data(){return{loginDialog:!1,loggingIn:!1,form:{username:"",password:""}}},methods:{logout(){fetch("https://linux1.csie.ntu.edu.tw:14443/logout",{credentials:"include"}).then((t=>t.json())).then((t=>{t.success?(this.$store.commit("logout"),this.$router.push("/")):alert(t.data)}))}}},u=l,d=n(1001),h=(0,d.Z)(u,a,c,!1,null,null,null),p=h.exports,m=n(5057),f=function(){var t=this,e=t._self._c;return e("div",{staticClass:"tw-flex tw-h-16 tw-items-center tw-text-center"},[e("span",{staticClass:"tw-flex-1"},[e("router-link",{attrs:{to:"/post"}},[e(m.Z,[t._v("mdi-post")])],1)],1),e("span",{staticClass:"tw-flex-1"},[e("router-link",{attrs:{to:"/phone"}},[e(m.Z,[t._v("mdi-phone")])],1)],1)])},g=[],w={},v=(0,d.Z)(w,f,g,!1,null,null,null),_=v.exports,x={name:"App",components:{Header:p,Navigation:_},mounted(){console.log("https://linux1.csie.ntu.edu.tw:14443"),fetch("https://linux1.csie.ntu.edu.tw:14443/status",{credentials:"include"}).then((t=>t.json())).then((t=>{t.success?t.data.username?(this.$store.commit("login",{username:t.data.username}),"login"==this.$route.name&&this.$router.push("/post")):this.$router.push("/"):alert(t.data)}))}},b=x,y=(0,d.Z)(b,o,i,!1,null,null,null),Z=y.exports,k=n(3806);s.ZP.use(k.Z);var C=new k.Z({}),$=n(8345),j=n(7179),P=n(3058),O=n(5223),S=n(1903),T=n(6904),I=n(3518),E=function(){var t=this,e=t._self._c;return e(S.Z,[e(P.Z,[e(O.EB,[t._v("登入")]),e(S.Z,{staticClass:"tw-pt-0"},[e(T.Z,{ref:"form"},[e(I.Z,{attrs:{label:"username",rules:t.required},model:{value:t.form.username,callback:function(e){t.$set(t.form,"username",e)},expression:"form.username"}}),e(I.Z,{attrs:{label:"password",type:"text",rules:t.required},model:{value:t.form.password,callback:function(e){t.$set(t.form,"password",e)},expression:"form.password"}}),e(j.Z,{attrs:{color:"primary",loading:t.loggingIn},on:{click:function(e){return t.login()}}},[t._v("登入")])],1)],1)],1),e("router-link",{attrs:{to:"/register"}},[e("span",{staticClass:"tw-mt-2 tw-text-center tw-w-full tw-inline-block"},[t._v("沒有帳號？點這裡註冊")])])],1)},R=[],D={name:"LoginView",data(){return{form:{username:"",password:""},loggingIn:!1,required:[t=>t instanceof String?!!t?.trim().length||"必填":t instanceof Number||(!!t||"必填")]}},methods:{login(){this.loggingIn=!0,fetch("https://linux1.csie.ntu.edu.tw:14443/login",{method:"POST",credentials:"include",body:JSON.stringify(this.form),headers:{"content-type":"application/json"}}).then((t=>t.json())).then((t=>{t.success?(this.$store.commit("login",{username:this.form.username}),"post"!=this.$route.name&&this.$router.push("/post")):alert(t.data),this.form.username="",this.form.password="",this.loggingIn=!1}))}}},N=D,V=(0,d.Z)(N,E,R,!1,null,null,null),q=V.exports,L=function(){var t=this,e=t._self._c;return e(S.Z,[e(P.Z,[e(O.EB,[t._v("註冊")]),e(S.Z,{staticClass:"tw-pt-0"},[e(T.Z,{ref:"form"},[e(I.Z,{attrs:{label:"username",rules:t.required},model:{value:t.form.username,callback:function(e){t.$set(t.form,"username",e)},expression:"form.username"}}),e(I.Z,{attrs:{label:"password",type:"text",rules:t.required},model:{value:t.form.password,callback:function(e){t.$set(t.form,"password",e)},expression:"form.password"}}),e(j.Z,{attrs:{color:"primary",loading:t.registering},on:{click:function(e){return t.register()}}},[t._v("註冊")])],1)],1)],1),e("router-link",{attrs:{to:"/"}},[e("span",{staticClass:"tw-mt-2 tw-text-center tw-w-full tw-inline-block"},[t._v("阿其實我註冊過了拉, 派謝")])])],1)},M=[],z={name:"RegisterView",data(){return{form:{username:"",password:""},registering:!1,required:[t=>t instanceof String?!!t?.trim().length||"必填":t instanceof Number||(!!t||"必填")]}},methods:{register(){this.registering=!0,fetch("https://linux1.csie.ntu.edu.tw:14443/register",{method:"POST",credentials:"include",body:JSON.stringify(this.form),headers:{"content-type":"application/json"}}).then((t=>t.json())).then((t=>{t.success?(alert("註冊成功 請登入"),this.$router.push("/")):alert(t.data),this.form.username="",this.form.password="",this.registering=!1}))}}},B=z,H=(0,d.Z)(B,L,M,!1,null,null,null),J=H.exports,A=n(3593),F=n(5234),U=n(5617),G=function(){var t=this,e=t._self._c;return e(S.Z,[e(A.Z,{attrs:{persistent:"","max-width":"600px"},scopedSlots:t._u([{key:"activator",fn:function({on:n,attrs:s}){return[e(j.Z,t._g(t._b({attrs:{color:"primary",dark:""}},"v-btn",s,!1),n),[t._v(" 新貼文 ")])]}}]),model:{value:t.dialog,callback:function(e){t.dialog=e},expression:"dialog"}},[e(P.Z,[e(O.EB,[e("span",{staticClass:"text-h5"},[t._v("新增貼文")])]),e(O.ZB,[e(S.Z,[e(I.Z,{attrs:{label:"標題"},model:{value:t.form.title,callback:function(e){t.$set(t.form,"title",e)},expression:"form.title"}}),e(U.Z,{attrs:{label:"內容"},model:{value:t.form.content,callback:function(e){t.$set(t.form,"content",e)},expression:"form.content"}})],1)],1),e(O.h7,[e(F.Z),e(j.Z,{attrs:{color:"primary"},on:{click:function(e){t.dialog=!1}}},[t._v(" Close ")]),e(j.Z,{attrs:{color:"primary",loading:t.saving},on:{click:function(e){t.post(),t.dialog=!1}}},[t._v(" Save ")])],1)],1)],1),t._l(t.posts,(function(n,s){return e(P.Z,{key:`post${s}`,staticClass:"my-2"},[e(O.ZB,{staticClass:"markdown-body",domProps:{innerHTML:t._s(t.markdown(n))}})],1)}))],2)},K=[];const Q=n(970);var W={name:"PostView",data(){return{posts:[],dialog:!1,form:{title:"",content:""},saving:!1}},mounted(){this.fetchPost()},methods:{fetchPost(){fetch("https://linux1.csie.ntu.edu.tw:14443/bulletin",{credentials:"include"}).then((t=>t.json())).then((t=>{t.success?this.posts=t.data:alert(t.data)}))},markdown({content:t,title:e,username:n}){return Q.parse(`\n# ${e}\n> 發文者: ${n}\n\n${t}\n            `)},post(){this.saving=!0,fetch("https://linux1.csie.ntu.edu.tw:14443/bulletin",{credentials:"include",method:"POST",body:JSON.stringify(this.form),headers:{"content-type":"application/json"}}).then((t=>t.json())).then((t=>{t.success?this.fetchPost():alert(t.data),this.saving=!1}))}}},X=W,Y=(0,d.Z)(X,G,K,!1,null,null,null),tt=Y.exports,et=n(248),nt=n(1908),st=n(8153),rt=n(6275),ot=function(){var t=this,e=t._self._c;return e(S.Z,[e("video",{ref:"originVideo",staticClass:"tw-rounded-xl tw-mb-4",attrs:{controls:"",muted:"",autoplay:""},domProps:{muted:!0}}),e("video",{ref:"remoteVideo",staticClass:"tw-rounded-xl tw-mb-4",attrs:{controls:"",muted:"",autoplay:""},domProps:{muted:!0}}),t.initializing?e("div",[e(rt.Z,{attrs:{indeterminate:"",color:"primary"}}),t._v(" 初始化連線... ")],1):t.connected?t._e():[t.contactList.length?e(et.Z,t._l(t.contactList,(function(n,s){return e(nt.Z,{key:`contact${s}`,on:{click:function(e){return t.connectRequest(n)}}},[e(st.km,[e(st.V9,[t._v(t._s(n.username))])],1)],1)})),1):e("div",[e("p",[t._v("目前沒有其他人上線，請你的朋友也打開這個頁面")]),e("p",[t._v("其實沒有朋友也沒有關係, 可以對著鏡子視訊")])]),e(j.Z,{attrs:{color:"primary"},on:{click:function(e){return t.fetchContacts()}}},[t._v("刷新列表")])]],2)},it=[],at={name:"Phoneview",data(){return{contacts:[],peer:void 0,sdp:void 0,candidates:[],initializing:!0,localStream:void 0,connected:!1}},mounted(){this.setupRTC()},methods:{async send(t){return fetch("https://linux1.csie.ntu.edu.tw:14443/phonebook",{credentials:"include",method:"POST",body:JSON.stringify(t),headers:{"content-type":"application/json"}}).then((t=>t.json())).then((t=>{console.log(t)}))},async fetchContacts(){return fetch("https://linux1.csie.ntu.edu.tw:14443/phonebook",{credentials:"include"}).then((t=>t.json())).then((t=>{t.success?this.contacts=t.data:alert(t.data)}))},async setupRTC(){const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});setTimeout((()=>{this.initializing=!1}),3e3),this.localStrem=t,this.$refs.originVideo.srcObject=t,this.peer=new RTCPeerConnection({iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"turn:140.112.30.32:3478",username:"username",credential:"password"}]}),this.peer.addStream(t),this.peer.onaddstream=t=>{this.$refs.remoteVideo.srcObject=t.stream,this.connected=!0,this.finished=!0},this.peer.onicecandidate=t=>{t.candidate?this.candidates.push(t.candidate):this.initializing=!1},this.sdp=await this.peer.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}),this.peer.setLocalDescription(this.sdp)},connectRequest(t){this.peer.setRemoteDescription(t.sdp,(()=>{this.peer.createAnswer().then((e=>{this.peer.setLocalDescription(e,(()=>{console.log(this.peer.localDescription,this.candidates),console.log("123"),this.send({username:this.$store.state.username,sdp:this.peer.localDescription,candidates:this.candidates,target:t.username})}))}))})),t.candidates.forEach((t=>{this.peer.addIceCandidate(t)}))},async pollingIncoming(){this.connected||(await fetch("https://linux1.csie.ntu.edu.tw:14443/phonebook",{credentials:"include"}).then((t=>t.json())).then((t=>{t.success?t.data.filter((t=>"answer"==t.sdp.type&&t.target==this.$store.state.username)).forEach((t=>{if(confirm(`您要跟${t.username}連線嗎？`)){this.peer.setRemoteDescription(t.sdp),t.candidates.forEach((t=>{this.peer.addIceCandidate(t)})),this.connected=!0;const e=[this.$store.state.username,t.username];e.forEach((t=>{fetch("https://linux1.csie.ntu.edu.tw:14443/phonebook",{credentials:"include",method:"DELETE",body:JSON.stringify({username:t}),headers:{"content-type":"application/json"}}).then((t=>t.json())).then((t=>{t.success||alert(t.data)}))}))}else;})):alert(t.data)})),setTimeout(this.pollingIncoming,1e3))}},computed:{contactList(){return this.contacts.filter((t=>t.username!=this.$store.state.username))}},watch:{initializing(t){0==t&&(console.log(this.candidates),this.send({username:this.$store.state.username,sdp:this.sdp,target:"",candidates:this.candidates}).then((()=>{this.fetchContacts().then((()=>{this.pollingIncoming()}))})))}}},ct=at,lt=(0,d.Z)(ct,ot,it,!1,null,null,null),ut=lt.exports;s.ZP.use($.ZP);const dt=[{path:"/",name:"login",component:q},{path:"/post",name:"post",component:tt},{path:"/phone",name:"phone",component:ut},{path:"/register",name:"register",component:J}],ht=new $.ZP({routes:dt});var pt=ht,mt=n(629);s.ZP.use(mt.ZP);var ft=new mt.ZP.Store({state:{loggedIn:!1,username:void 0},getters:{},mutations:{login(t,{username:e}){t.username=e,t.loggedIn=!0},logout(t){t.username=void 0,t.loggedIn=!1}},actions:{},modules:{}});s.ZP.config.productionTip=!1,new s.ZP({vuetify:C,router:pt,store:ft,render:t=>t(Z)}).$mount("#app")}},e={};function n(s){var r=e[s];if(void 0!==r)return r.exports;var o=e[s]={exports:{}};return t[s](o,o.exports,n),o.exports}n.m=t,function(){var t=[];n.O=function(e,s,r,o){if(!s){var i=1/0;for(u=0;u<t.length;u++){s=t[u][0],r=t[u][1],o=t[u][2];for(var a=!0,c=0;c<s.length;c++)(!1&o||i>=o)&&Object.keys(n.O).every((function(t){return n.O[t](s[c])}))?s.splice(c--,1):(a=!1,o<i&&(i=o));if(a){t.splice(u--,1);var l=r();void 0!==l&&(e=l)}}return e}o=o||0;for(var u=t.length;u>0&&t[u-1][2]>o;u--)t[u]=t[u-1];t[u]=[s,r,o]}}(),function(){n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,{a:e}),e}}(),function(){n.d=function(t,e){for(var s in e)n.o(e,s)&&!n.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){var t={143:0};n.O.j=function(e){return 0===t[e]};var e=function(e,s){var r,o,i=s[0],a=s[1],c=s[2],l=0;if(i.some((function(e){return 0!==t[e]}))){for(r in a)n.o(a,r)&&(n.m[r]=a[r]);if(c)var u=c(n)}for(e&&e(s);l<i.length;l++)o=i[l],n.o(t,o)&&t[o]&&t[o][0](),t[o]=0;return n.O(u)},s=self["webpackChunkcn_project_messaging"]=self["webpackChunkcn_project_messaging"]||[];s.forEach(e.bind(null,0)),s.push=e.bind(null,s.push.bind(s))}();var s=n.O(void 0,[998],(function(){return n(9205)}));s=n.O(s)})();
//# sourceMappingURL=app.a746d3d1.js.map